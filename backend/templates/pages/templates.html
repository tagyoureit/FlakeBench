{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Templates - Unistore Benchmark{% endblock %}

{% block content %}
<div x-data="templatesManager()">
    <div class="card">
        <div class="card-title">Test Configuration Templates</div>
        <p>Manage reusable test templates. All tests run from templates.</p>
        
        <div class="flex justify-between items-center mt-4">
            <div class="form-group mb-0" style="flex: 1; max-width: 400px;">
                <input type="text" 
                       class="form-input" 
                       x-model="searchQuery" 
                       placeholder="Search templates..."
                       @input="filterTemplates">
            </div>
            
            <button class="btn btn-primary" @click="createNewTemplate">
                <span>+ New Template</span>
            </button>
        </div>
    </div>

    <!-- Error State -->
    <div x-show="!loading && error" class="alert alert-error">
        <strong>Failed to load templates.</strong>
        <span x-text="error"></span>
        <div class="mt-2 text-sm">
            If this looks like a Snowflake connectivity issue, connect to VPN / allowlist your IP and refresh.
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-8">
        <div class="loading-spinner" style="display: inline-block;"></div>
        <p class="mt-2">Loading templates...</p>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && !error && filteredTemplates.length === 0" class="card text-center">
        <div class="py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium">No templates found</h3>
            <p class="mt-1 text-sm text-gray-500" x-show="searchQuery">
                No templates match "<span x-text="searchQuery"></span>"
            </p>
            <p class="mt-1 text-sm text-gray-500" x-show="!searchQuery">
                Get started by creating your first template
            </p>
            <div class="mt-6">
                <button class="btn btn-primary" @click="createNewTemplate">
                    <span>+ Create Template</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Templates List -->
    <div x-show="!loading && !error && filteredTemplates.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
        <template x-for="template in filteredTemplates" :key="template.template_id">
            <div class="card hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-lg font-semibold" x-text="template.template_name"></h3>
                        <span x-show="template.usage_count > 0" class="text-xs text-gray-500">
                            Used <span x-text="template.usage_count"></span> time(s)
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary btn-sm" 
                                x-show="template.usage_count === 0"
                                @click="editTemplate(template)"
                                title="Edit template">
                            Edit
                        </button>
                        <button class="btn btn-secondary btn-sm"
                                x-show="template.usage_count > 0"
                                @click="viewTemplateDetails(template)"
                                title="View template details (read-only)">
                            View details
                        </button>
                        <button class="btn btn-danger btn-sm" 
                                @click="deleteTemplate(template)"
                                title="Delete template and all results">
                            Delete
                        </button>
                    </div>
                </div>
                
                <p class="text-sm text-gray-600 mb-3" x-text="template.description || 'No description'"></p>
                
                <div class="text-xs text-gray-500 space-y-1">
                    <div>
                        <strong>Table:</strong> 
                        <span x-text="template.config?.database + '.' + template.config?.schema + '.' + template.config?.table_name"></span>
                    </div>
                    <div>
                        <strong>Workload:</strong> 
                        <span x-text="deriveWorkloadLabel(template.config)"></span>
                    </div>
                    <div>
                        <strong>Duration:</strong> 
                        <span x-text="template.config?.duration + 's'"></span>
                    </div>
                    <div>
                        <strong>Connections:</strong> 
                        <span x-text="template.config?.concurrent_connections"></span>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-4 pt-3 border-t border-gray-200">
                    <button class="btn btn-primary flex-1" 
                            @click="prepareTest(template)">
                        Prepare Test
                    </button>
                    <button class="btn btn-secondary" 
                            @click="duplicateTemplate(template)"
                            title="Copy this template">
                        Copy
                    </button>
                </div>
            </div>
        </template>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}{% endblock %}
