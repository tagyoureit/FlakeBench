{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Dashboard - Unistore Benchmark{% endblock %}

{% block content %}
<div x-data="dashboard({ mode: 'live' })" data-test-id="{{ test_id or '' }}">
    <div class="dashboard-top-grid">
        <div class="card" x-show="templateInfo">
            <div
                class="card-title"
                x-text="templateInfo ? (templateInfo.template_name || templateInfo.test_name || '') : ''"
            ></div>
            <div class="text-sm text-gray-600">
                <div>
                    <strong>Template:</strong>
                    <span x-text="templateInfo ? (templateInfo.template_name || templateInfo.test_name || '') : ''"></span>
                </div>
                <div class="mt-1">
                    <strong>Table:</strong>
                    <span x-text="templateInfo ? (templateInfo.table_full_name || '') : ''"></span>
                    (<span x-text="templateInfo ? (templateInfo.table_type || '') : ''"></span>)
                </div>
                <div class="mt-1">
                    <strong>Warehouse:</strong>
                    <span x-text="templateInfo ? (templateInfo.warehouse || 'default') : 'default'"></span>
                    <span x-show="templateInfo && templateInfo.warehouse_size">(<span x-text="templateInfo ? (templateInfo.warehouse_size || '') : ''"></span>)</span>
                </div>
                <div class="mt-1">
                    <strong>Workload:</strong>
                    <span x-text="templateInfo ? (templateInfo.workload_type || '') : ''"></span>
                    • <strong>Concurrency:</strong> <span x-text="templateInfo ? (templateInfo.concurrent_connections ?? '') : ''"></span>
                    • <strong>Duration:</strong> <span x-text="templateInfo ? (templateInfo.duration_seconds ?? '') : ''"></span>s
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Test Control Panel</div>

            <div class="btn-group">
                <button
                    class="btn btn-success"
                    :disabled="(status || '').toUpperCase() !== 'PREPARED' && (status || '').toUpperCase() !== 'READY'"
                    @click="startTest()">
                    <span class="loading-spinner htmx-indicator"></span>
                    Start
                </button>
                <button
                    class="btn btn-error"
                    :disabled="(status || '').toUpperCase() !== 'RUNNING'"
                    @click="stopTest()">
                    Stop
                </button>
                <button
                    class="btn btn-primary"
                    :disabled="!testId || !status || ['PREPARED','READY'].includes((status || '').toUpperCase())"
                    @click="openRunAnalysis()">
                    Open run analysis
                </button>
            </div>

            <div x-show="testRunning">
                <div class="form-group">
                    <label class="form-label">Test Progress</label>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" :style="`width: ${progress}%`"></div>
                    </div>
                    <div class="progress-meta">
                        <small x-text="`${elapsed}s / ${duration}s`"></small>
                        <span
                            class="status-badge"
                            x-show="phaseLabel()"
                            :class="phaseBadgeClass()"
                            x-text="phaseLabel()"
                        ></span>
                    </div>
                    <small
                        class="progress-phase-details"
                        x-show="phaseTimingText()"
                        x-text="phaseTimingText()"
                    ></small>
                </div>
            </div>
        </div>
    </div>
    
    {% include "components/latency_sections.html" %}
    
    <div class="card">
        <div class="card-title">Real-Time Metrics</div>
        <div class="chart-container">
            <canvas id="throughputChart"></canvas>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">Latency Distribution</div>
        <div class="chart-container">
            <canvas id="latencyChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-title">Run Logs</div>

        <div
            class="alert alert-error"
            x-show="(status || '').toUpperCase() === 'FAILED'"
        >
            Test failed. See logs below.
        </div>

        <pre class="log-output" x-text="logsText() || 'No logs yet.'"></pre>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}{% endblock %}
