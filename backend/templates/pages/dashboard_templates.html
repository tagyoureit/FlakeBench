{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Template Analysis - FlakeBench{% endblock %}

{% block content %}
<div x-data="templateAnalysis()" x-init="init()">
    <!-- Page Header -->
    <div class="card card-compact">
        <div class="flex items-center justify-between">
            <div>
                <div class="card-title card-title--compact">Template Analysis</div>
                <p class="text-gray-600">Deep dive into individual template performance, trends, and distributions</p>
            </div>
            <a href="/analysis" class="btn btn-secondary btn-sm" hx-get="/analysis" hx-target="#main-content" hx-push-url="true">
                ‚Üê Back to Comparison
            </a>
        </div>
    </div>

    <!-- Template List -->
    <div>
        <!-- Filters -->
        <div class="card card-compact my-4">
            <div class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="form-label">Table Type</label>
                    <select class="form-select" x-model="filters.tableType" @change="loadTemplates()">
                        <option value="">All Types</option>
                        <option value="STANDARD">Standard</option>
                        <option value="HYBRID">Hybrid</option>
                        <option value="INTERACTIVE">Interactive</option>
                        <option value="POSTGRES">Postgres</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Sort By</label>
                    <select class="form-select" x-model="filters.sortBy" @change="loadTemplates()">
                        <option value="last_run">Last Run</option>
                        <option value="total_runs">Total Runs</option>
                        <option value="avg_qps">Avg QPS</option>
                        <option value="avg_p95_ms">Avg P95</option>
                    </select>
                </div>
                <div class="flex-1"></div>
                <div class="text-sm text-gray-500" x-show="templates.length">
                    Showing <span x-text="templates.length"></span> of <span x-text="totalCount"></span> templates
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loadingList" class="card">
            <div class="flex items-center justify-center py-8">
                <div class="loading-spinner w-6 h-6 border-4 rounded-full animate-spin"></div>
                <span class="ml-3 text-gray-600">Loading templates...</span>
            </div>
        </div>

        <!-- Template Grid -->
        <div x-show="!loadingList && templates.length" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 my-4">
            <template x-for="t in templates" :key="t.template_id">
                <a class="card hover:shadow-lg transition-shadow cursor-pointer block no-underline" 
                   :href="'/configure?template_id=' + t.template_id + '&mode=view'"
                   hx-get.attr="'/configure?template_id=' + t.template_id + '&mode=view'"
                   hx-target="#main-content" hx-push-url="true">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-bold text-gray-800 truncate flex-1" x-text="t.template_name"></h4>
                        <span class="inline-flex items-center gap-1.5 py-1.5 px-3 rounded-full text-xs font-medium ml-2" 
                              :class="getStabilityClass(t.stability_badge)">
                            <!-- Very Stable: checkmark -->
                            <svg x-show="t.stability_badge === 'very_stable'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Stable: shield -->
                            <svg x-show="t.stability_badge === 'stable'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 1c.293 0 .573.112.774.307l6.5 6A1 1 0 0118 8v6a4 4 0 01-4 4H6a4 4 0 01-4-4V8a1 1 0 01.726-.693l6.5-6A1.003 1.003 0 0110 1zm0 2.414L4 8.586V14a2 2 0 002 2h8a2 2 0 002-2V8.586L10 3.414z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Moderate: minus circle -->
                            <svg x-show="t.stability_badge === 'moderate'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.75 9.25a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Volatile: warning triangle -->
                            <svg x-show="t.stability_badge === 'volatile'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                            <span x-text="getStabilityLabel(t.stability_badge)"></span>
                        </span>
                    </div>
                    
                    <div class="flex items-center gap-2 text-sm text-gray-500 mb-3">
                        <span class="px-2 py-0.5 bg-gray-100 rounded" x-text="t.table_type"></span>
                        <span x-show="t.warehouse_size" x-text="t.warehouse_size"></span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-center border-t pt-3">
                        <div>
                            <div class="text-lg font-bold text-gray-800" x-text="t.total_runs"></div>
                            <div class="text-xs text-gray-500">Runs</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-blue-600" x-text="formatNumber(t.avg_qps, 0)"></div>
                            <div class="text-xs text-gray-500">Avg QPS</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-orange-600" x-text="formatLatency(t.avg_p95_ms)"></div>
                            <div class="text-xs text-gray-500">Avg P95</div>
                        </div>
                    </div>
                    
                    <div x-show="t.cost_per_1k_ops_usd" class="mt-3 pt-3 border-t text-center">
                        <span class="text-sm text-gray-600">Cost/1K Ops: </span>
                        <span class="font-semibold text-green-600">$<span x-text="formatNumber(t.cost_per_1k_ops_usd, 4)"></span></span>
                    </div>
                    
                    <div class="mt-2 text-xs text-gray-400 text-right" x-show="t.last_run">
                        Last run: <span x-text="formatDate(t.last_run)"></span>
                    </div>
                </a>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="!loadingList && !templates.length" class="card text-center py-8">
            <p class="text-gray-500">No templates found matching your filters.</p>
        </div>

        <!-- Load More -->
        <div x-show="templates.length < totalCount" class="text-center my-4">
            <button class="btn btn-secondary" @click="loadMore()" :disabled="loadingList">
                Load More
            </button>
        </div>
    </div>
</div>

{% endblock %}
