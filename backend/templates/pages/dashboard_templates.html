{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Template Analysis - FlakeBench{% endblock %}

{% block content %}
<div x-data="templateAnalysis()" x-init="init()">
    <!-- Page Header -->
    <div class="card card-compact">
        <div class="flex items-center justify-between">
            <div>
                <div class="card-title card-title--compact">Template Analysis</div>
                <p class="text-gray-600">Deep dive into individual template performance, trends, and distributions</p>
            </div>
            <a href="/analysis" class="btn btn-secondary btn-sm" hx-get="/analysis" hx-target="#main-content" hx-push-url="true">
                ← Back to Comparison
            </a>
        </div>
    </div>

    <!-- Template List / Selection View -->
    <div x-show="!selectedTemplate">
        <!-- Filters -->
        <div class="card card-compact my-4">
            <div class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="form-label">Table Type</label>
                    <select class="form-select" x-model="filters.tableType" @change="loadTemplates()">
                        <option value="">All Types</option>
                        <option value="STANDARD">Standard</option>
                        <option value="HYBRID">Hybrid</option>
                        <option value="INTERACTIVE">Interactive</option>
                        <option value="POSTGRES">Postgres</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Sort By</label>
                    <select class="form-select" x-model="filters.sortBy" @change="loadTemplates()">
                        <option value="last_run">Last Run</option>
                        <option value="total_runs">Total Runs</option>
                        <option value="avg_qps">Avg QPS</option>
                        <option value="avg_p95_ms">Avg P95</option>
                    </select>
                </div>
                <div class="flex-1"></div>
                <div class="text-sm text-gray-500" x-show="templates.length">
                    Showing <span x-text="templates.length"></span> of <span x-text="totalCount"></span> templates
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loadingList" class="card">
            <div class="flex items-center justify-center py-8">
                <div class="loading-spinner w-6 h-6 border-4 rounded-full animate-spin"></div>
                <span class="ml-3 text-gray-600">Loading templates...</span>
            </div>
        </div>

        <!-- Template Grid -->
        <div x-show="!loadingList && templates.length" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 my-4">
            <template x-for="t in templates" :key="t.template_id">
                <div class="card hover:shadow-lg transition-shadow cursor-pointer" @click="selectTemplate(t.template_id)">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-bold text-gray-800 truncate flex-1" x-text="t.template_name"></h4>
                        <span class="inline-flex items-center gap-1.5 py-1.5 px-3 rounded-full text-xs font-medium ml-2" 
                              :class="getStabilityClass(t.stability_badge)">
                            <!-- Very Stable: checkmark -->
                            <svg x-show="t.stability_badge === 'very_stable'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Stable: shield -->
                            <svg x-show="t.stability_badge === 'stable'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 1c.293 0 .573.112.774.307l6.5 6A1 1 0 0118 8v6a4 4 0 01-4 4H6a4 4 0 01-4-4V8a1 1 0 01.726-.693l6.5-6A1.003 1.003 0 0110 1zm0 2.414L4 8.586V14a2 2 0 002 2h8a2 2 0 002-2V8.586L10 3.414z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Moderate: minus circle -->
                            <svg x-show="t.stability_badge === 'moderate'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.75 9.25a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Volatile: warning triangle -->
                            <svg x-show="t.stability_badge === 'volatile'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                            <span x-text="getStabilityLabel(t.stability_badge)"></span>
                        </span>
                    </div>
                    
                    <div class="flex items-center gap-2 text-sm text-gray-500 mb-3">
                        <span class="px-2 py-0.5 bg-gray-100 rounded" x-text="t.table_type"></span>
                        <span x-show="t.warehouse_size" x-text="t.warehouse_size"></span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-center border-t pt-3">
                        <div>
                            <div class="text-lg font-bold text-gray-800" x-text="t.total_runs"></div>
                            <div class="text-xs text-gray-500">Runs</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-blue-600" x-text="formatNumber(t.avg_qps, 0)"></div>
                            <div class="text-xs text-gray-500">Avg QPS</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-orange-600" x-text="formatLatency(t.avg_p95_ms)"></div>
                            <div class="text-xs text-gray-500">Avg P95</div>
                        </div>
                    </div>
                    
                    <div x-show="t.cost_per_1k_ops_usd" class="mt-3 pt-3 border-t text-center">
                        <span class="text-sm text-gray-600">Cost/1K Ops: </span>
                        <span class="font-semibold text-green-600">$<span x-text="formatNumber(t.cost_per_1k_ops_usd, 4)"></span></span>
                    </div>
                    
                    <div class="mt-2 text-xs text-gray-400 text-right" x-show="t.last_run">
                        Last run: <span x-text="formatDate(t.last_run)"></span>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="!loadingList && !templates.length" class="card text-center py-8">
            <p class="text-gray-500">No templates found matching your filters.</p>
        </div>

        <!-- Load More -->
        <div x-show="templates.length < totalCount" class="text-center my-4">
            <button class="btn btn-secondary" @click="loadMore()" :disabled="loadingList">
                Load More
            </button>
        </div>
    </div>

    <!-- Template Detail View -->
    <div x-show="selectedTemplate">
        <!-- Back Button + Header -->
        <div class="card card-compact my-4">
            <div class="flex items-center gap-4">
                <button class="btn btn-secondary btn-sm" @click="clearSelection()">← Back to List</button>
                <div class="flex-1">
                    <h2 class="text-xl font-bold" x-text="templateStats?.template_name"></h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="inline-flex items-center py-1.5 px-3 rounded-full text-xs font-medium bg-slate-100 text-slate-700" 
                              x-text="templateStats?.table_type"></span>
                        <span x-show="templateStats?.warehouse_size" class="text-sm text-gray-500" x-text="templateStats?.warehouse_size"></span>
                        <span x-show="templateStats?.load_mode" class="text-sm text-gray-500" x-text="templateStats?.load_mode"></span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <template x-for="badge in templateStats?.badges || []" :key="badge">
                        <span class="inline-flex items-center gap-1.5 py-1.5 px-3 rounded-full text-xs font-medium" 
                              :class="getBadgeClass(badge)">
                            <!-- Highest QPS: rocket -->
                            <svg x-show="badge === 'highest_qps'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.606 12.97a.75.75 0 01-.134 1.051 2.494 2.494 0 00-.93 2.437 2.494 2.494 0 002.437-.93.75.75 0 111.186.918 3.995 3.995 0 01-4.482 1.332.75.75 0 01-.461-.461 3.994 3.994 0 011.332-4.482.75.75 0 011.052.134z" clip-rule="evenodd"/>
                                <path fill-rule="evenodd" d="M5.752 12A13.07 13.07 0 008 14.248v4.002c0 .414.336.75.75.75a5 5 0 004.797-6.414 12.984 12.984 0 005.45-10.848.75.75 0 00-.735-.735 12.984 12.984 0 00-10.849 5.45A5 5 0 001 11.25c.001.414.337.75.751.75h4.001zM13 9a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Lowest Latency: bolt -->
                            <svg x-show="badge === 'lowest_latency'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M11.983 1.907a.75.75 0 00-1.292-.657l-8.5 9.5A.75.75 0 002.75 12h6.572l-1.305 6.093a.75.75 0 001.292.657l8.5-9.5A.75.75 0 0017.25 8h-6.572l1.305-6.093z"/>
                            </svg>
                            <!-- Improving: trending up -->
                            <svg x-show="badge === 'improving'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.577 4.878a.75.75 0 01.919-.53l4.78 1.281a.75.75 0 01.531.919l-1.281 4.78a.75.75 0 01-1.449-.387l.81-3.022a19.407 19.407 0 00-5.594 5.203.75.75 0 01-1.139.093L7 10.06l-4.72 4.72a.75.75 0 01-1.06-1.061l5.25-5.25a.75.75 0 011.06 0l3.074 3.073a20.923 20.923 0 015.545-4.931l-3.042-.815a.75.75 0 01-.53-.919z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Degrading: trending down -->
                            <svg x-show="badge === 'degrading'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M1.22 5.222a.75.75 0 011.06 0L7 9.942l3.768-3.769a.75.75 0 011.113.058 20.908 20.908 0 013.813 7.254l1.574-2.727a.75.75 0 011.3.75l-2.475 4.286a.75.75 0 01-1.025.275l-4.287-2.475a.75.75 0 01.75-1.3l2.71 1.565a19.422 19.422 0 00-3.013-6.024L7.53 11.533a.75.75 0 01-1.06 0l-5.25-5.25a.75.75 0 010-1.06z" clip-rule="evenodd"/>
                            </svg>
                            <!-- High Confidence: checkmark -->
                            <svg x-show="badge === 'high_confidence'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Low Sample: exclamation -->
                            <svg x-show="badge === 'low_sample'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Zero Errors: shield check -->
                            <svg x-show="badge === 'zero_errors'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9.661 2.237a.531.531 0 01.678 0 11.947 11.947 0 007.078 2.749.5.5 0 01.479.425c.069.52.104 1.05.104 1.59 0 5.162-3.26 9.563-7.834 11.256a.48.48 0 01-.332 0C5.26 16.564 2 12.163 2 7c0-.538.035-1.069.104-1.589a.5.5 0 01.48-.425 11.947 11.947 0 007.077-2.75zm4.196 5.954a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
                            </svg>
                            <span x-text="getBadgeLabel(badge)"></span>
                        </span>
                    </template>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loadingDetail" class="card">
            <div class="flex items-center justify-center py-8">
                <div class="loading-spinner w-6 h-6 border-4 rounded-full animate-spin"></div>
                <span class="ml-3 text-gray-600">Loading template details...</span>
            </div>
        </div>

        <!-- Stats Summary Cards -->
        <div x-show="templateStats && !loadingDetail" class="grid grid-cols-2 md:grid-cols-4 gap-4 my-4">
            <!-- QPS Stats -->
            <div class="card text-center">
                <h4 class="text-sm text-gray-500 mb-1">QPS</h4>
                <div class="text-2xl font-bold text-blue-600" x-text="formatNumber(templateStats?.qps_stats?.avg, 1)"></div>
                <div class="text-xs text-gray-400">
                    Range: <span x-text="formatNumber(templateStats?.qps_stats?.min, 0)"></span> - 
                    <span x-text="formatNumber(templateStats?.qps_stats?.max, 0)"></span>
                </div>
                <div class="text-xs text-gray-400" x-show="templateStats?.qps_stats?.cv">
                    CV: <span x-text="formatPercent(templateStats?.qps_stats?.cv)"></span>
                </div>
            </div>
            
            <!-- P95 Stats -->
            <div class="card text-center">
                <h4 class="text-sm text-gray-500 mb-1">P95 Latency</h4>
                <div class="text-2xl font-bold text-orange-600" x-text="formatLatency(templateStats?.p95_stats?.avg)"></div>
                <div class="text-xs text-gray-400">
                    Range: <span x-text="formatLatency(templateStats?.p95_stats?.min)"></span> - 
                    <span x-text="formatLatency(templateStats?.p95_stats?.max)"></span>
                </div>
            </div>
            
            <!-- Cost Stats -->
            <div class="card text-center">
                <h4 class="text-sm text-gray-500 mb-1">Cost/1K Ops</h4>
                <div class="text-2xl font-bold text-green-600" x-text="templateStats?.cost_stats?.cost_per_1k_ops_usd ? ('$' + formatNumber(templateStats?.cost_stats?.cost_per_1k_ops_usd, 4)) : 'N/A'"></div>
                <div class="text-xs text-gray-400">
                    Total: $<span x-text="formatNumber(templateStats?.cost_stats?.total_cost_usd, 2)"></span>
                </div>
            </div>
            
            <!-- Stability -->
            <div class="card text-center">
                <h4 class="text-sm text-gray-500 mb-1">Stability</h4>
                <div class="text-2xl font-bold" :class="getStabilityTextClass(templateStats?.stability?.badge)"
                     x-text="getStabilityLabel(templateStats?.stability?.badge)"></div>
                <div class="text-xs text-gray-400" x-show="templateStats?.stability?.trend_direction">
                    Trend: <span x-text="templateStats?.stability?.trend_direction"></span>
                    (<span x-text="formatPercent(Math.abs(templateStats?.stability?.trend_pct || 0) / 100)"></span>)
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div x-show="templateStats && !loadingDetail" class="grid grid-cols-1 lg:grid-cols-2 gap-4 my-4">
            <!-- Distribution Histogram -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="card-title card-title--compact">P95 Distribution</h3>
                    <select class="form-select form-select-sm" x-model="distributionMetric" @change="loadDistribution()">
                        <option value="p95_latency_ms">P95 Latency</option>
                        <option value="qps">QPS</option>
                        <option value="p50_latency_ms">P50 Latency</option>
                        <option value="p99_latency_ms">P99 Latency</option>
                    </select>
                </div>
                <div class="relative" style="height: 250px;">
                    <canvas id="distribution-chart"></canvas>
                </div>
            </div>
            
            <!-- Scatter Plot -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="card-title card-title--compact">Performance Scatter</h3>
                    <div class="flex gap-2">
                        <select class="form-select form-select-sm" x-model="scatterX" @change="loadScatter()">
                            <option value="duration_seconds">Duration</option>
                            <option value="concurrency">Concurrency</option>
                        </select>
                        <span class="text-gray-500">vs</span>
                        <select class="form-select form-select-sm" x-model="scatterY" @change="loadScatter()">
                            <option value="qps">QPS</option>
                            <option value="p95">P95</option>
                        </select>
                    </div>
                </div>
                <div class="relative" style="height: 250px;">
                    <canvas id="scatter-chart"></canvas>
                </div>
                <div x-show="scatterCorrelation !== null" class="text-center text-sm text-gray-500 mt-2">
                    Correlation: <span x-text="scatterCorrelation?.toFixed(3)"></span>
                </div>
            </div>
        </div>

        <!-- Historical Runs Table -->
        <div x-show="templateStats && !loadingDetail" class="card my-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="card-title card-title--compact">Historical Runs</h3>
                <span class="text-sm text-gray-500" x-text="'Total: ' + (runsTotal || 0) + ' runs'"></span>
            </div>
            
            <div class="overflow-x-auto">
                <table class="table table-compact w-full">
                    <thead>
                        <tr>
                            <th class="cursor-pointer" @click="sortRuns('start_time')">
                                Date <span x-show="runsSortBy === 'start_time'" x-text="runsSortOrder === 'desc' ? '↓' : '↑'"></span>
                            </th>
                            <th>Duration</th>
                            <th>Concurrency</th>
                            <th class="cursor-pointer" @click="sortRuns('qps')">
                                QPS <span x-show="runsSortBy === 'qps'" x-text="runsSortOrder === 'desc' ? '↓' : '↑'"></span>
                            </th>
                            <th class="cursor-pointer" @click="sortRuns('p95')">
                                P95 <span x-show="runsSortBy === 'p95'" x-text="runsSortOrder === 'desc' ? '↓' : '↑'"></span>
                            </th>
                            <th>P99</th>
                            <th>Error Rate</th>
                            <th>Cost/1K</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="run in runs" :key="run.test_id">
                            <tr :class="run.is_outlier ? 'bg-yellow-50' : ''">
                                <td x-text="formatDateTime(run.start_time)"></td>
                                <td x-text="formatDuration(run.duration_seconds)"></td>
                                <td x-text="run.concurrent_connections || '-'"></td>
                                <td class="font-semibold" x-text="formatNumber(run.qps, 1)"></td>
                                <td x-text="formatLatency(run.p95_ms)"></td>
                                <td x-text="formatLatency(run.p99_ms)"></td>
                                <td :class="run.error_rate > 0.01 ? 'text-red-600' : ''" 
                                    x-text="formatPercent(run.error_rate)"></td>
                                <td x-text="run.cost_per_1k_ops_usd ? ('$' + formatNumber(run.cost_per_1k_ops_usd, 4)) : '-'"></td>
                                <td>
                                    <a :href="'/dashboard/' + run.test_id" 
                                       class="text-blue-600 hover:underline text-sm"
                                       :hx-get="'/dashboard/' + run.test_id"
                                       hx-target="#main-content" 
                                       hx-push-url="true">
                                        View
                                    </a>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div x-show="runsTotal > runsPageSize" class="flex items-center justify-between mt-4 pt-4 border-t">
                <button class="btn btn-secondary btn-sm" 
                        @click="prevRunsPage()" 
                        :disabled="runsPage <= 1">
                    ← Previous
                </button>
                <span class="text-sm text-gray-500">
                    Page <span x-text="runsPage"></span> of <span x-text="Math.ceil(runsTotal / runsPageSize)"></span>
                </span>
                <button class="btn btn-secondary btn-sm" 
                        @click="nextRunsPage()" 
                        :disabled="runsPage >= Math.ceil(runsTotal / runsPageSize)">
                    Next →
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
