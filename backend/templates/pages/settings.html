{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Settings - FlakeBench{% endblock %}

{% block content %}
<div x-data="flakebench.settingsPage()">
    <!-- Page Header -->
    <div class="card card-compact">
        <div class="flex justify-between items-center">
            <div>
                <div class="card-title card-title--compact">Settings</div>
                <p>Manage database connections and application configuration</p>
            </div>
        </div>
    </div>

    <!-- Connections Section -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="card-title card-title--compact">Database Connections</h2>
                <p class="text-sm text-gray-600">
                    Configure connections to Snowflake and Postgres databases.
                    <span class="text-blue-600">Credentials are stored securely in Snowflake.</span>
                </p>
            </div>
            <button 
                type="button" 
                class="btn btn-primary"
                @click="openAddModal()"
            >
                + Add Connection
            </button>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="text-center py-8">
            <span class="loading-spinner"></span>
            <div class="text-gray-500 mt-2">Loading connections...</div>
        </div>

        <!-- Error State -->
        <div x-show="error && !loading" class="alert alert-error mb-4">
            <span x-text="error"></span>
            <button type="button" class="ml-2 underline" @click="loadConnections()">Retry</button>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && !error && connections.length === 0" class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
            <div class="text-gray-500 mb-2">No connections configured</div>
            <button type="button" class="btn btn-secondary btn-sm" @click="openAddModal()">
                Add your first connection
            </button>
        </div>

        <!-- Connections Table -->
        <div x-show="!loading && connections.length > 0" class="overflow-x-auto">
            <table class="table w-full">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Host / Account</th>
                        <th>Credentials</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="conn in connections" :key="conn.connection_id">
                        <tr class="hover:bg-gray-50">
                            <td>
                                <div class="flex items-center gap-2">
                                    <span x-text="conn.connection_name" class="font-medium"></span>
                                    <span x-show="conn.is_default" class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Default</span>
                                </div>
                            </td>
                            <td>
                                <span 
                                    class="text-xs px-2 py-1 rounded"
                                    :class="{
                                        'bg-blue-100 text-blue-800': conn.connection_type === 'SNOWFLAKE',
                                        'bg-green-100 text-green-800': conn.connection_type === 'POSTGRES'
                                    }"
                                    x-text="formatConnectionType(conn.connection_type)"
                                ></span>
                            </td>
                            <td>
                                <span x-text="conn.connection_type === 'SNOWFLAKE' ? conn.account : conn.host"></span>
                                <span x-show="conn.port" class="text-gray-500" x-text="':' + conn.port"></span>
                            </td>
                            <td>
                                <div class="flex items-center gap-1">
                                    <span 
                                        class="text-xs px-2 py-1 rounded"
                                        :class="conn.has_password || conn.has_private_key ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                        x-text="conn.has_password || conn.has_private_key ? 'Configured' : 'Not set'"
                                    ></span>
                                    <span x-show="conn.username" class="text-xs text-gray-500" x-text="'(' + conn.username + ')'"></span>
                                </div>
                            </td>
                            <td class="text-right">
                                <div class="flex justify-end gap-1">
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-secondary"
                                        @click="openTestModal(conn)"
                                        title="Test connection"
                                    >
                                        Test
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-secondary"
                                        @click="openEditModal(conn)"
                                        title="Edit connection"
                                    >
                                        Edit
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-secondary"
                                        @click="setDefault(conn)"
                                        :disabled="conn.is_default"
                                        title="Set as default"
                                    >
                                        Set Default
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-danger"
                                        @click="confirmDelete(conn)"
                                        title="Delete connection"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cost Settings Section -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="card-title card-title--compact">Cost Settings</h2>
                <p class="text-sm text-gray-600">Configure cost estimation parameters for benchmarks.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="form-label">Cost per Credit ($)</label>
                <input 
                    type="number" 
                    class="form-input"
                    step="0.01"
                    min="0"
                    x-model.number="costSettings.dollarsPerCredit"
                    @change="saveCostSettings()"
                >
                <p class="text-xs text-gray-500 mt-1">
                    Default: $4.00 (Enterprise tier). Adjust based on your Snowflake contract.
                </p>
            </div>
            
            <div class="flex items-center gap-4 pt-6">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input 
                        type="checkbox" 
                        x-model="costSettings.showCredits"
                        @change="saveCostSettings()"
                        class="rounded"
                    >
                    <span class="text-sm">Show credits in tooltips</span>
                </label>
            </div>
        </div>

        <div class="mt-4 pt-4 border-t">
            <h4 class="font-medium text-sm mb-2">Warehouse Credit Rates (Reference)</h4>
            <div class="text-xs text-gray-600 grid grid-cols-3 md:grid-cols-6 gap-2">
                <span>XSMALL: 1/hr</span>
                <span>SMALL: 2/hr</span>
                <span>MEDIUM: 4/hr</span>
                <span>LARGE: 8/hr</span>
                <span>XLARGE: 16/hr</span>
                <span>2XLARGE: 32/hr</span>
            </div>
        </div>
    </div>

    <!-- Add/Edit Connection Modal -->
    <div 
        x-show="showModal" 
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        @click.self="closeModal()"
        @keydown.escape.window="closeModal()"
    >
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" x-text="editingConnection ? 'Edit Connection' : 'Add Connection'"></h3>
                <button 
                    type="button" 
                    class="text-gray-500 hover:text-gray-700 text-2xl"
                    @click="closeModal()"
                >&times;</button>
            </div>
            
            <form @submit.prevent="saveConnection()">
                <!-- Connection Name -->
                <div class="mb-4">
                    <label class="form-label">Connection Name *</label>
                    <input 
                        type="text" 
                        class="form-input"
                        x-model="formData.connection_name"
                        placeholder="e.g., Production Snowflake"
                        required
                    >
                </div>

                <!-- Connection Type -->
                <div class="mb-4">
                    <label class="form-label">Connection Type *</label>
                    <select 
                        class="form-select"
                        x-model="formData.connection_type"
                        @change="onTypeChange()"
                        required
                    >
                        <option value="">Select type...</option>
                        <option value="SNOWFLAKE">Snowflake</option>
                        <option value="POSTGRES">PostgreSQL</option>
                    </select>
                </div>

                <!-- Snowflake Fields -->
                <div x-show="formData.connection_type === 'SNOWFLAKE'" class="space-y-4">
                    <div>
                        <label class="form-label">Account Identifier *</label>
                        <input 
                            type="text" 
                            class="form-input"
                            x-model="formData.account"
                            placeholder="e.g., org-account or account.region"
                        >
                        <p class="text-xs text-gray-500 mt-1">Your Snowflake account identifier</p>
                    </div>
                    <div>
                        <label class="form-label">Role</label>
                        <input 
                            type="text" 
                            class="form-input"
                            x-model="formData.role"
                            placeholder="e.g., ACCOUNTADMIN"
                        >
                    </div>
                </div>

                <!-- Postgres Fields -->
                <div x-show="formData.connection_type === 'POSTGRES'" class="space-y-4">
                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-2">
                            <label class="form-label">Host *</label>
                            <input 
                                type="text" 
                                class="form-input"
                                x-model="formData.host"
                                placeholder="e.g., localhost or db.example.com"
                            >
                        </div>
                        <div>
                            <label class="form-label">Port</label>
                            <input 
                                type="number" 
                                class="form-input"
                                x-model.number="formData.port"
                                placeholder="5432"
                            >
                        </div>
                        <div>
                            <label class="form-label">PgBouncer Port</label>
                            <input 
                                type="number" 
                                class="form-input"
                                x-model.number="formData.pgbouncer_port"
                                placeholder="5431"
                            >
                            <p class="text-xs text-gray-500 mt-1">Optional</p>
                        </div>
                    </div>
                </div>

                <!-- Credentials Section -->
                <div x-show="formData.connection_type" class="mt-6 pt-4 border-t">
                    <h4 class="font-medium mb-2">Credentials</h4>
                    <p class="text-xs text-gray-500 mb-4">
                        <span class="text-blue-600">Credentials are stored securely in Snowflake.</span>
                        <span x-show="editingConnection && editingConnection.has_password" class="text-green-600 ml-2">Password already configured - leave blank to keep existing.</span>
                    </p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Username</label>
                            <input 
                                type="text" 
                                class="form-input"
                                x-model="formData.username"
                                :placeholder="editingConnection?.username || 'Enter username'"
                                autocomplete="off"
                            >
                        </div>
                        <div>
                            <label class="form-label">Password</label>
                            <input 
                                type="password" 
                                class="form-input"
                                x-model="formData.password"
                                :placeholder="editingConnection?.has_password ? '••••••••' : 'Enter password'"
                                autocomplete="new-password"
                            >
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-2 mt-6 pt-4 border-t">
                    <button 
                        type="button" 
                        class="btn btn-secondary"
                        @click="closeModal()"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                        :disabled="saving"
                    >
                        <span x-show="!saving" x-text="editingConnection ? 'Save Changes' : 'Create Connection'"></span>
                        <span x-show="saving">Saving...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Connection Modal -->
    <div 
        x-show="showTestModal" 
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        @click.self="closeTestModal()"
        @keydown.escape.window="closeTestModal()"
    >
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Test Connection</h3>
                <button 
                    type="button" 
                    class="text-gray-500 hover:text-gray-700 text-2xl"
                    @click="closeTestModal()"
                >&times;</button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600">
                    Testing: <span class="font-medium" x-text="testingConnection?.connection_name"></span>
                </p>
                <p x-show="testingConnection?.has_password" class="text-xs text-green-600 mt-1">
                    Using stored credentials (user: <span x-text="testingConnection?.username"></span>)
                </p>
                <p x-show="!testingConnection?.has_password" class="text-xs text-yellow-600 mt-1">
                    No credentials stored - please configure credentials first
                </p>
            </div>

            <!-- Test Result -->
            <div x-show="testResult" class="mt-4">
                <div 
                    class="p-3 rounded"
                    :class="testResult?.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'"
                >
                    <div class="flex items-center gap-2">
                        <span x-show="testResult?.success" class="text-green-600">&#10003;</span>
                        <span x-show="!testResult?.success" class="text-red-600">&#10007;</span>
                        <span 
                            class="font-medium"
                            :class="testResult?.success ? 'text-green-800' : 'text-red-800'"
                            x-text="testResult?.message"
                        ></span>
                    </div>
                    <div x-show="testResult?.latency_ms" class="text-xs text-gray-500 mt-1">
                        Latency: <span x-text="testResult?.latency_ms?.toFixed(0)"></span>ms
                    </div>
                    <div x-show="testResult?.server_version" class="text-xs text-gray-500">
                        Version: <span x-text="testResult?.server_version"></span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-2 mt-6">
                <button 
                    type="button" 
                    class="btn btn-secondary"
                    @click="closeTestModal()"
                >
                    Close
                </button>
                <button 
                    type="button" 
                    class="btn btn-primary"
                    @click="runTest()"
                    :disabled="testing || !testingConnection?.has_password"
                >
                    <span x-show="!testing">Test Connection</span>
                    <span x-show="testing">Testing...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div 
        x-show="showDeleteModal" 
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        @click.self="showDeleteModal = false"
        @keydown.escape.window="showDeleteModal = false"
    >
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-red-600">Delete Connection</h3>
                <button 
                    type="button" 
                    class="text-gray-500 hover:text-gray-700 text-2xl"
                    @click="showDeleteModal = false"
                >&times;</button>
            </div>
            
            <p class="mb-4">
                Are you sure you want to delete <span class="font-medium" x-text="deletingConnection?.connection_name"></span>?
            </p>
            <p class="text-sm text-gray-500 mb-4">
                This will permanently remove the connection and its stored credentials.
            </p>

            <div class="flex justify-end gap-2">
                <button 
                    type="button" 
                    class="btn btn-secondary"
                    @click="showDeleteModal = false"
                >
                    Cancel
                </button>
                <button 
                    type="button" 
                    class="btn btn-danger"
                    @click="deleteConnection()"
                    :disabled="deleting"
                >
                    <span x-show="!deleting">Delete</span>
                    <span x-show="deleting">Deleting...</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
