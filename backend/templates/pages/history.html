{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Test History - FlakeBench{% endblock %}

{% block content %}
<div x-data="testHistory()">
    <div class="card card-compact">
        <div class="card-title card-title--compact">Test History</div>
        <p>Browse and manage all previous test results</p>
    </div>

    <details class="card card-collapsible">
        <summary class="card-collapsible__summary">
            <span class="card-title card-title--compact">Filters</span>
        </summary>
        <div class="card-collapsible__body">
            <div class="filters-grid">
            <div>
                <label class="form-label">Table Type</label>
                <select class="form-select" x-model="filters.table_type" @change="applyFilters">
                    <option value="">All Types</option>
                    <option value="STANDARD">Standard</option>
                    <option value="HYBRID">Hybrid</option>
                    <option value="INTERACTIVE">Interactive</option>
                    <option value="POSTGRES">Postgres</option>
                    <option value="VIEW">View</option>
                </select>
            </div>

            <div>
                <label class="form-label">Warehouse Size</label>
                <select class="form-select" x-model="filters.warehouse_size" @change="applyFilters">
                    <option value="">All Sizes</option>
                    <option value="XSMALL">X-Small</option>
                    <option value="SMALL">Small</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="LARGE">Large</option>
                    <option value="XLARGE">X-Large</option>
                </select>
            </div>

            <div>
                <label class="form-label">Load Mode</label>
                <select class="form-select" x-model="filters.load_mode" @change="applyFilters">
                    <option value="">All Modes</option>
                    <option value="CONCURRENCY">Concurrency</option>
                    <option value="QPS">QPS</option>
                    <option value="FIND_MAX_CONCURRENCY">Find Max</option>
                </select>
            </div>

            <div>
                <label class="form-label">Scaling Mode</label>
                <select class="form-select" x-model="filters.scaling_mode" @change="applyFilters">
                    <option value="">All Scaling</option>
                    <option value="FIXED">Fixed</option>
                    <option value="AUTO">Auto</option>
                    <option value="BOUNDED">Bounded</option>
                </select>
            </div>

            <div>
                <label class="form-label">Status</label>
                <select class="form-select" x-model="filters.status" @change="applyFilters">
                    <option value="">All Statuses</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="RUNNING">Running</option>
                    <option value="FAILED">Failed</option>
                    <option value="CANCELLED">Cancelled</option>
                </select>
            </div>

            <div>
                <label class="form-label">Date Range</label>
                <select class="form-select" x-model="filters.date_range" @change="applyFilters">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">Past Week</option>
                    <option value="month">Past Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="filters-custom-range" x-show="filters.date_range === 'custom'">
                <div>
                    <label class="form-label">Start Date</label>
                    <input
                        type="date"
                        class="form-input"
                        x-model="filters.start_date"
                        @change="applyFilters"
                    >
                </div>
                <div>
                    <label class="form-label">End Date</label>
                    <input
                        type="date"
                        class="form-input"
                        x-model="filters.end_date"
                        @change="applyFilters"
                    >
                </div>
            </div>
        </div>

            <div class="form-group">
                <label class="form-label">Search Tests</label>
                <input
                    type="text"
                    class="form-input"
                    x-model="filters.search_query"
                    @keydown.enter="applyFilters"
                    placeholder="Search by test name..."
                >
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" @click="resetFilters">Reset Filters</button>
                <button type="button" class="btn btn-primary" :disabled="applyingFilters" @click="applyFilters">
                    <span class="loading-spinner" x-show="applyingFilters"></span>
                    <span x-text="applyingFilters ? 'Applying…' : 'Apply'"></span>
                </button>
            </div>
        </div>
    </details>

    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <div class="card-title card-title--compact mb-0">
                Compare
                (<span x-text="compareTests.length"></span>/2)
            </div>
            <div class="btn-group">
                <button
                    type="button"
                    class="btn btn-secondary btn-sm"
                    @click="clearCompare"
                    :disabled="compareTests.length === 0"
                >
                    Clear
                </button>
            </div>
        </div>

        <div x-show="compareError" class="alert alert-error mb-4">
            <strong>Compare error.</strong>
            <span x-text="compareError"></span>
        </div>

        <div x-show="compareTests.length > 0" class="mb-4">
            <div class="font-semibold mb-2">Selected for Comparison</div>
            <div class="flex flex-wrap gap-2">
                <template x-for="test in compareTests" :key="test.test_id">
                    <div class="inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-800">
                        <span x-text="test.test_name" class="mr-2"></span>
                        <button
                            type="button"
                            class="text-blue-600 hover:text-blue-800"
                            @click="toggleCompare(test.test_id)"
                            title="Remove from compare"
                        >&times;</button>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="compareTests.length < 2" class="alert alert-info">
            Select 2 tests (from search or from the table below) to compare high-level metrics.
        </div>

        <div x-show="compareTests.length === 2" class="mt-4">
            <div class="font-semibold mb-2">High-level Comparison</div>
            <div class="table">
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <th x-text="test.test_name"></th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-semibold">Table Type</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td x-text="test.table_type"></td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Warehouse / Instance Size</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td x-text="test.postgres_instance_size || test.warehouse_size || '—'"></td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Threads</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td x-text="test.concurrent_connections"></td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Operations / Second</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.ops_per_sec || 0).toFixed(0)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.ops_per_sec === Math.max(...compareTests.map(t => t.ops_per_sec)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.ops_per_sec === Math.max(...compareTests.map(t => t.ops_per_sec))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">P50 Latency (ms)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.p50_latency || 0).toFixed(2)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.p50_latency === Math.min(...compareTests.map(t => t.p50_latency)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.p50_latency === Math.min(...compareTests.map(t => t.p50_latency))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">P95 Latency (ms)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.p95_latency || 0).toFixed(2)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.p95_latency === Math.min(...compareTests.map(t => t.p95_latency)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.p95_latency === Math.min(...compareTests.map(t => t.p95_latency))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">P99 Latency (ms)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.p99_latency || 0).toFixed(2)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.p99_latency === Math.min(...compareTests.map(t => t.p99_latency)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.p99_latency === Math.min(...compareTests.map(t => t.p99_latency))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Error Rate (%)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.error_rate || 0).toFixed(2)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.error_rate === Math.min(...compareTests.map(t => t.error_rate)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.error_rate === Math.min(...compareTests.map(t => t.error_rate))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Test Duration (s)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td x-text="Number(test.duration || 0).toFixed(0)"></td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Estimated Cost</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span 
                                        class="cursor-help"
                                        x-text="window.CostUtils ? window.CostUtils.formatCostForTableType(test.estimated_cost_usd, test.table_type, test.cost_calculation_method) : '$' + (test.estimated_cost_usd || 0).toFixed(4)"
                                        :title="window.CostUtils ? window.CostUtils.generateCostTooltip({
                                            warehouseSize: test.postgres_instance_size || test.warehouse_size,
                                            tableType: test.table_type,
                                            durationSeconds: test.duration,
                                            creditsUsed: test.credits_used,
                                            creditsPerHour: test.credits_per_hour,
                                            estimatedCostUsd: test.estimated_cost_usd,
                                            dollarsPerCredit: costSettings.dollarsPerCredit,
                                            nodeCount: test.node_count
                                        }) : ''"
                                    ></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="(test.estimated_cost_usd || 0) > 0 && (test.estimated_cost_usd || 0) === Math.min(...compareTests.filter(t => (t.estimated_cost_usd || 0) > 0).map(t => t.estimated_cost_usd)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="(test.estimated_cost_usd || 0) > 0 && (test.estimated_cost_usd || 0) === Math.min(...compareTests.filter(t => (t.estimated_cost_usd || 0) > 0).map(t => t.estimated_cost_usd))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Cost per 1K Ops</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="window.CostUtils ? window.CostUtils.formatCostForTableType(test.cost_per_1k_ops, test.table_type, test.cost_calculation_method) : '$' + (test.cost_per_1k_ops || 0).toFixed(4)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="(test.cost_per_1k_ops || 0) > 0 && (test.cost_per_1k_ops || 0) === Math.min(...compareTests.filter(t => (t.cost_per_1k_ops || 0) > 0).map(t => t.cost_per_1k_ops)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="(test.cost_per_1k_ops || 0) > 0 && (test.cost_per_1k_ops || 0) === Math.min(...compareTests.filter(t => (t.cost_per_1k_ops || 0) > 0).map(t => t.cost_per_1k_ops))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="btn-group mt-4">
                <button
                    type="button"
                    class="btn btn-primary btn-sm"
                    :disabled="deepCompareLoading"
                    @click="openDeepCompare"
                >
                    <span class="loading-spinner" x-show="deepCompareLoading"></span>
                    <span x-text="deepCompareLoading ? 'Loading…' : 'Deep Compare'"></span>
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <div class="card-title card-title--compact mb-0">Test Results</div>
            <div>
                <span class="text-sm text-gray-600">
                    Showing <span x-text="tests.length"></span> results
                </span>
            </div>
        </div>

        <div x-show="error" class="alert alert-error">
            <strong>Failed to load test results.</strong>
            <span x-text="error"></span>
            <div class="mt-2 text-sm">
                If this looks like a Snowflake connectivity issue, connect to VPN / allowlist your IP and refresh.
            </div>
        </div>

        <div class="table">
            <table>
                <thead>
                    <tr>
                        <th @click="sortBy('test_name')" class="cursor-pointer">
                            Test Name 
                            <span x-show="sortField === 'test_name'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th @click="sortBy('warehouse_size')" class="cursor-pointer">
                            Config
                            <span x-show="sortField === 'warehouse_size'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th>Workload</th>
                        <th @click="sortBy('created_at')" class="cursor-pointer">
                            Date
                            <span x-show="sortField === 'created_at'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th @click="sortBy('ops_per_sec')" class="cursor-pointer">
                            Results
                            <span x-show="sortField === 'ops_per_sec'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="test in sortedTests" :key="test.test_id">
                        <tr>
                            <td>
                                <div class="flex items-center gap-2">
                                    <img
                                        x-show="tableTypeIconSrc(test)"
                                        class="template-type-icon"
                                        style="width: 20px; height: 20px;"
                                        :src="tableTypeIconSrc(test)"
                                        :alt="tableTypeLabel(test)"
                                        :title="tableTypeLabel(test)"
                                    >
                                    <a
                                        :href="dashboardUrl(test)"
                                        class="text-blue-600 hover:underline"
                                        x-text="test.test_name"
                                    ></a>
                                </div>
                            </td>
                            <!-- Config: Size • Load Mode • Scaling -->
                            <td>
                                <div class="flex flex-col text-sm">
                                    <span x-text="sizeDisplay(test)"></span>
                                    <span class="text-gray-600" x-html="loadModeDisplay(test)"></span>
                                    <span class="text-gray-500 text-xs" x-html="scalingDisplay(test)"></span>
                                </div>
                            </td>
                            <!-- Workload: Reads on top, Writes on bottom -->
                            <td>
                                <div class="flex flex-col text-sm">
                                    <span x-html="workloadReadsDisplay(test)"></span>
                                    <span class="text-gray-600" x-html="workloadWritesDisplay(test)"></span>
                                </div>
                            </td>
                            <!-- Date -->
                            <td class="text-sm" x-text="new Date(test.created_at).toLocaleDateString()"></td>
                            <!-- Results: QPS / Duration / P95 -->
                            <td>
                                <div class="flex flex-col text-sm">
                                    <span><strong x-text="test.ops_per_sec.toFixed(0)"></strong> <span class="text-gray-500">QPS</span></span>
                                    <span class="text-gray-600" x-text="durationDisplay(test)"></span>
                                    <span class="text-gray-500 text-xs" x-text="'P95: ' + test.p95_latency.toFixed(0) + 'ms'"></span>
                                </div>
                            </td>
                            <td>
                                <div class="flex flex-col gap-1">
                                    <span 
                                        class="status-badge"
                                        :class="(() => {
                                            const phase = test.phase ? test.phase.toUpperCase() : null;
                                            const status = test.status ? test.status.toUpperCase() : '';
                                            if (phase && (status === 'RUNNING' || phase === 'PROCESSING')) {
                                                return {
                                                    'status-preparing': phase === 'PREPARING',
                                                    'status-warmup': phase === 'WARMUP' || phase === 'WARM-UP',
                                                    'status-running': phase === 'RUNNING',
                                                    'status-processing': phase === 'PROCESSING'
                                                };
                                            }
                                            return {
                                                'status-completed': status === 'COMPLETED',
                                                'status-running': status === 'RUNNING',
                                                'status-failed': status === 'FAILED',
                                                'status-paused': status === 'PAUSED',
                                                'status-cancelled': status === 'CANCELLED'
                                            };
                                        })()"
                                        x-text="test.phase && (test.status === 'RUNNING' || test.phase === 'PROCESSING') ? test.phase : test.status">
                                    </span>
                                    <template x-if="test.status && test.status.toUpperCase() === 'FAILED' && test.failure_reason">
                                        <span 
                                            class="text-xs text-red-600 max-w-[200px] truncate cursor-help"
                                            :title="test.failure_reason"
                                            x-text="test.failure_reason.length > 50 ? test.failure_reason.substring(0, 50) + '...' : test.failure_reason">
                                        </span>
                                    </template>
                                </div>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button 
                                        type="button" 
                                        class="btn btn-primary btn-sm"
                                        title="View Details"
                                        :disabled="isTestActionInProgress(test.test_id)"
                                        @click="viewTest(test)">
                                        <span class="loading-spinner" x-show="viewingTestId === test.test_id"></span>
                                        <span x-show="viewingTestId !== test.test_id">View</span>
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm"
                                        :class="isCompared(test.test_id) ? 'btn-success' : 'btn-secondary'"
                                        :title="isCompared(test.test_id) ? 'Remove from Compare' : 'Add to Compare'"
                                        @click="toggleCompare(test.test_id)"
                                        :disabled="isTogglingCompare(test.test_id) || isTestActionInProgress(test.test_id) || (!isCompared(test.test_id) && compareTests.length >= 2)"
                                    >
                                        <span class="loading-spinner" x-show="isTogglingCompare(test.test_id)"></span>
                                        <span x-show="!isTogglingCompare(test.test_id)" x-text="isCompared(test.test_id) ? 'Remove' : 'Compare'"></span>
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-secondary btn-sm"
                                        title="Run Again"
                                        :disabled="isTestActionInProgress(test.test_id)"
                                        @click="rerunTest(test.test_id)">
                                        <span class="loading-spinner" x-show="rerunningTestId === test.test_id"></span>
                                        <span x-show="rerunningTestId !== test.test_id">Rerun</span>
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-error btn-sm"
                                        title="Delete Test"
                                        :disabled="isTestActionInProgress(test.test_id)"
                                        @click="deleteTest(test.test_id)">
                                        <span class="loading-spinner" x-show="isDeleting(test.test_id)"></span>
                                        <span x-show="!isDeleting(test.test_id)">Delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div x-show="!error && tests.length === 0" class="alert alert-info">
            No test results found. Run your first test to see results here.
        </div>

        <div class="flex justify-between items-center mt-4" x-show="totalPages > 1">
            <button 
                type="button" 
                class="btn btn-secondary"
                @click="previousPage"
                :disabled="currentPage === 1">
                Previous
            </button>
            <span class="text-sm text-gray-600">
                Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
            </span>
            <button 
                type="button" 
                class="btn btn-secondary"
                @click="nextPage"
                :disabled="currentPage === totalPages">
                Next
            </button>
        </div>
    </div>

</div>
{% endblock %}

{# testHistory() is defined in /static/js/history.js and loaded globally #}
