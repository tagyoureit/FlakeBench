<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FlakeBench{% endblock %}</title>
    
    <!-- Tailwind CSS (compiled from input.css) -->
    <link rel="stylesheet" href="/static/css/tailwind.css?v=2">
    
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/ws.js"></script>
    <script src="/static/js/toast.js"></script>
    <script src="/static/js/cost-utils.js"></script>
    <script src="/static/js/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script defer src="/static/js/templates_manager.js"></script>
    <script defer src="/static/js/settings_page.js?v=2"></script>
    <!-- Dashboard modules (load before main dashboard.js) -->
    <script defer src="/static/js/dashboard/state.js?v=5"></script>
    <script defer src="/static/js/dashboard/formatters.js?v=5"></script>
    <script defer src="/static/js/dashboard/test-actions.js?v=2"></script>
    <script defer src="/static/js/dashboard/display.js?v=3"></script>
    <script defer src="/static/js/dashboard/workers.js?v=2"></script>
    <script defer src="/static/js/dashboard/find-max.js?v=2"></script>
    <script defer src="/static/js/dashboard/slo.js?v=2"></script>
    <script defer src="/static/js/dashboard/latency.js?v=2"></script>
    <script defer src="/static/js/dashboard/phase.js?v=2"></script>
    <script defer src="/static/js/dashboard/websocket.js?v=2"></script>
    <script defer src="/static/js/dashboard/timers.js?v=2"></script>
    <script defer src="/static/js/dashboard/logs.js?v=2"></script>
    <script defer src="/static/js/dashboard/polling.js?v=2"></script>
    <script defer src="/static/js/dashboard/timeseries.js?v=3"></script>
    <script defer src="/static/js/dashboard/breakdown.js?v=2"></script>
    <script defer src="/static/js/dashboard/step-history.js?v=2"></script>
    <script defer src="/static/js/dashboard/ai.js?v=2"></script>
    <script defer src="/static/js/dashboard/ui.js?v=6"></script>
    <script defer src="/static/js/dashboard/data-loading.js?v=4"></script>
    <script defer src="/static/js/dashboard/historical-metrics.js?v=4"></script>
    <!-- Main dashboard (composes all modules) -->
    <script defer src="/static/js/dashboard.js?v=6"></script>
    <script defer src="/static/js/display-utils.js"></script>
    <script defer src="/static/js/history.js"></script>
    <script defer src="/static/js/compare_detail.js"></script>
    <script defer src="/static/js/alpine.min.js"></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    {% include 'components/navbar.html' %}
    
    <main id="main-content" hx-history-elt class="relative">
        <div class="container">
            {% block content %}{% endblock %}
        </div>

        <!-- Global Page Navigation Spinner (content-anchored) -->
        <div id="page-loading-overlay" class="absolute inset-0 z-50 hidden pointer-events-none flex items-center justify-center">
            <div class="flex items-center gap-2 rounded-md border border-gray-200 bg-white/95 px-4 py-2 shadow-sm">
                <div style="width: 18px; height: 18px; border: 3px solid #bfdbfe; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                <span class="text-sm text-gray-700">Loading data...</span>
            </div>
        </div>
    </main>

    <div
        id="toast-container"
        class="toast-container"
        aria-live="polite"
        aria-atomic="true"
    ></div>
    
    {% include 'components/footer.html' %}
    
    <script>
        function updateActiveNavbarTab() {
            const currentPath = window.location.pathname;
            const links = document.querySelectorAll('.navbar nav a[href]');

            links.forEach((link) => {
                const href = link.getAttribute('href');
                if (!href) return;

                let hrefPath;
                try {
                    hrefPath = new URL(href, window.location.origin).pathname;
                } catch {
                    return;
                }

                const isMatch = currentPath === hrefPath || currentPath.startsWith(hrefPath + '/');

                link.classList.toggle('active', isMatch);
            });
        }

        document.addEventListener('DOMContentLoaded', updateActiveNavbarTab);
        
        // Global page navigation loading indicator
        const pageOverlay = document.getElementById('page-loading-overlay');
        const OVERLAY_MIN_VISIBLE_MS = 160;
        const OVERLAY_QUIET_MS = 120;
        const OVERLAY_SESSION_MAX_MS = 15000;
        const OVERLAY_BOOTSTRAP_WINDOW_MS = 4000;
        let overlayShownAt = 0;
        let overlayVisible = false;
        let overlayHideTimer = null;
        let overlaySessionTimer = null;
        let overlaySessionActive = false;
        let overlayBootstrapArmed = false;
        let pendingMainContentSwap = false;
        let pendingTrackedFetches = 0;
        let lastOverlayActivityAt = 0;

        function isMainContentTarget(event) {
            return Boolean(event?.detail?.target && event.detail.target.id === 'main-content');
        }

        function showPageOverlay() {
            if (!pageOverlay) return;
            if (overlayHideTimer) {
                clearTimeout(overlayHideTimer);
                overlayHideTimer = null;
            }
            if (!overlayVisible) {
                overlayVisible = true;
                overlayShownAt = Date.now();
                pageOverlay.classList.remove('hidden');
            }
        }

        function forceHidePageOverlay() {
            if (!pageOverlay) return;
            if (overlayHideTimer) {
                clearTimeout(overlayHideTimer);
                overlayHideTimer = null;
            }
            overlayVisible = false;
            pageOverlay.classList.add('hidden');
        }

        function clearOverlayHideTimer() {
            if (overlayHideTimer) {
                clearTimeout(overlayHideTimer);
                overlayHideTimer = null;
            }
        }

        function clearOverlaySessionTimer() {
            if (overlaySessionTimer) {
                clearTimeout(overlaySessionTimer);
                overlaySessionTimer = null;
            }
        }

        function touchOverlayActivity() {
            lastOverlayActivityAt = Date.now();
        }

        function beginOverlaySession() {
            overlaySessionActive = true;
            overlayBootstrapArmed = false;
            pendingMainContentSwap = false;
            pendingTrackedFetches = 0;
            touchOverlayActivity();
            clearOverlaySessionTimer();
            overlaySessionTimer = window.setTimeout(function() {
                // Fail-safe so polling endpoints can never pin the overlay forever.
                endOverlaySession({ hide: true });
            }, OVERLAY_SESSION_MAX_MS);
        }

        function endOverlaySession(options = {}) {
            const hide = options.hide !== false;
            overlaySessionActive = false;
            overlayBootstrapArmed = false;
            pendingMainContentSwap = false;
            pendingTrackedFetches = 0;
            clearOverlayHideTimer();
            clearOverlaySessionTimer();
            if (hide) {
                hidePageOverlay();
            }
        }

        function maybeFinishOverlaySession() {
            if (!overlaySessionActive) return;
            if (pendingMainContentSwap) return;
            if (pendingTrackedFetches > 0) return;
            const idleForMs = Date.now() - lastOverlayActivityAt;
            const waitMs = Math.max(0, OVERLAY_QUIET_MS - idleForMs);
            clearOverlayHideTimer();
            overlayHideTimer = window.setTimeout(function() {
                if (!overlaySessionActive) return;
                if (pendingMainContentSwap || pendingTrackedFetches > 0) return;
                endOverlaySession({ hide: true });
            }, waitMs);
        }

        function armBootstrapOverlaySession() {
            beginOverlaySession();
            overlayBootstrapArmed = true;
            window.setTimeout(function() {
                if (!overlaySessionActive || !overlayBootstrapArmed) return;
                overlayBootstrapArmed = false;
                maybeFinishOverlaySession();
            }, OVERLAY_BOOTSTRAP_WINDOW_MS);
        }

        function normalizeFetchUrl(resource) {
            if (typeof resource === 'string') return resource;
            if (resource instanceof URL) return resource.toString();
            if (resource && typeof resource.url === 'string') return resource.url;
            return '';
        }

        function isConfigureRoute() {
            return window.location.pathname === '/configure';
        }

        function isTrackableFetch(resource) {
            const rawUrl = normalizeFetchUrl(resource);
            if (!rawUrl) return false;
            let url;
            try {
                url = new URL(rawUrl, window.location.origin);
            } catch {
                return false;
            }
            if (url.origin !== window.location.origin) return false;
            if (url.pathname.startsWith('/static/')) return false;
            const isAssetRequest = /\.(?:css|js|map|png|jpe?g|gif|webp|svg|ico|woff2?|ttf|eot)$/i.test(url.pathname);
            if (isAssetRequest) return false;
            return true;
        }

        function hidePageOverlay() {
            if (!overlayVisible) return;
            const elapsed = Date.now() - overlayShownAt;
            const waitMs = Math.max(0, OVERLAY_MIN_VISIBLE_MS - elapsed);
            clearOverlayHideTimer();
            overlayHideTimer = window.setTimeout(forceHidePageOverlay, waitMs);
        }

        function isModifiedClick(event) {
            return event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button !== 0;
        }

        function isInternalNavigationAnchor(anchor) {
            const href = anchor.getAttribute('href');
            if (!href || href.startsWith('#') || href.startsWith('javascript:')) return false;

            let url;
            try {
                url = new URL(href, window.location.origin);
            } catch {
                return false;
            }

            const isSamePageHash = url.pathname === window.location.pathname &&
                url.search === window.location.search &&
                url.hash;

            if (isSamePageHash) return false;
            if (url.origin !== window.location.origin) return false;
            if (anchor.target && anchor.target !== '_self') return false;
            return true;
        }

        document.body.addEventListener('htmx:beforeRequest', function(event) {
            if (isMainContentTarget(event)) {
                if (!overlaySessionActive) {
                    beginOverlaySession();
                }
                pendingMainContentSwap = true;
                touchOverlayActivity();
                showPageOverlay();
            }
        });
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });
        document.body.addEventListener('htmx:afterSettle', function(event) {
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });
        document.body.addEventListener('htmx:responseError', function(event) {
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });
        document.body.addEventListener('htmx:sendError', function(event) {
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });
        document.body.addEventListener('htmx:timeout', function(event) {
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });

        if (window.fetch) {
            const originalFetch = window.fetch.bind(window);
            window.fetch = function(resource, init) {
                const shouldTrack = isTrackableFetch(resource) && (overlaySessionActive || isConfigureRoute());
                if (shouldTrack) {
                    if (!overlaySessionActive) {
                        beginOverlaySession();
                    }
                    pendingTrackedFetches += 1;
                    touchOverlayActivity();
                    if (overlayVisible || overlayBootstrapArmed || pendingMainContentSwap) {
                        showPageOverlay();
                    } else if (isConfigureRoute()) {
                        showPageOverlay();
                    }
                }

                return originalFetch(resource, init).finally(function() {
                    if (!shouldTrack) return;
                    pendingTrackedFetches = Math.max(0, pendingTrackedFetches - 1);
                    touchOverlayActivity();
                    maybeFinishOverlaySession();
                });
            };
        }

        // Full-page navigations and reloads (outside HTMX lifecycle)
        document.addEventListener('click', function(event) {
            const anchor = event.target?.closest?.('a[href]');
            if (!anchor) return;
            if (event.defaultPrevented || isModifiedClick(event)) return;
            if (anchor.matches('[hx-get], [hx-post], [hx-put], [hx-patch], [hx-delete], [hx-boost]')) return;
            if (!isInternalNavigationAnchor(anchor)) return;
            if (!overlaySessionActive) {
                beginOverlaySession();
            }
            showPageOverlay();
        }, true);

        document.addEventListener('submit', function(event) {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) return;
            if (form.matches('[hx-get], [hx-post], [hx-put], [hx-patch], [hx-delete], [hx-boost]')) return;
            if (!overlaySessionActive) {
                beginOverlaySession();
            }
            showPageOverlay();
        }, true);

        window.addEventListener('beforeunload', showPageOverlay);
        window.addEventListener('pageshow', function() {
            endOverlaySession({ hide: true });
        });
        document.addEventListener('DOMContentLoaded', armBootstrapOverlaySession);
        
        // Clean up Alpine components BEFORE HTMX swaps content to prevent
        // "X is not defined" errors during navigation transitions.
        document.body.addEventListener('htmx:beforeSwap', function(event) {
            if (window.Alpine && event.detail && event.detail.target) {
                const target = event.detail.target;
                // Destroy all Alpine components in the target before swapping
                const alpineElements = target.querySelectorAll('[x-data]');
                alpineElements.forEach(function(el) {
                    try {
                        if (el._x_dataStack) {
                            window.Alpine.destroyTree(el);
                        }
                    } catch (_) {
                        // Ignore cleanup errors
                    }
                });
            }
        });
        
        document.body.addEventListener('htmx:afterSwap', function(event) {
            updateActiveNavbarTab();
            // Alpine's MutationObserver automatically initializes new x-data elements
            // No manual initTree needed - this was causing double-initialization bugs
        });
        document.body.addEventListener('htmx:historyRestore', function(event) {
            updateActiveNavbarTab();
            // Alpine's MutationObserver handles re-initialization automatically
        });
        window.addEventListener('popstate', updateActiveNavbarTab);
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
