<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Unistore Performance Benchmark{% endblock %}</title>
    
    <link rel="stylesheet" href="/static/css/app.css">
    
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/ws.js"></script>
    <script src="/static/js/toast.js"></script>
    <script defer src="/static/js/templates_manager.js"></script>
    <script defer src="/static/js/dashboard.js?v=3"></script>
    <script defer src="/static/js/history.js"></script>
    <script defer src="/static/js/compare_detail.js"></script>
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/chart.min.js"></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    {% include 'components/navbar.html' %}
    
    <main id="main-content" hx-history-elt>
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <div
        id="toast-container"
        class="toast-container"
        aria-live="polite"
        aria-atomic="true"
    ></div>
    
    {% include 'components/footer.html' %}
    
    <script>
        function updateActiveNavbarTab() {
            const currentPath = window.location.pathname;
            const links = document.querySelectorAll('.navbar nav a[href]');

            links.forEach((link) => {
                const href = link.getAttribute('href');
                if (!href) return;

                let hrefPath;
                try {
                    hrefPath = new URL(href, window.location.origin).pathname;
                } catch {
                    return;
                }

                const isMatch = currentPath === hrefPath || currentPath.startsWith(hrefPath + '/');

                link.classList.toggle('active', isMatch);
            });
        }

        document.addEventListener('DOMContentLoaded', updateActiveNavbarTab);
        
        // Clean up Alpine components BEFORE HTMX swaps content to prevent
        // "X is not defined" errors during navigation transitions.
        document.body.addEventListener('htmx:beforeSwap', function(event) {
            if (window.Alpine && event.detail && event.detail.target) {
                const target = event.detail.target;
                // Destroy all Alpine components in the target before swapping
                const alpineElements = target.querySelectorAll('[x-data]');
                alpineElements.forEach(function(el) {
                    try {
                        if (el._x_dataStack) {
                            window.Alpine.destroyTree(el);
                        }
                    } catch (_) {
                        // Ignore cleanup errors
                    }
                });
            }
        });
        
        document.body.addEventListener('htmx:afterSwap', function(event) {
            updateActiveNavbarTab();
            // Alpine's MutationObserver automatically initializes new x-data elements
            // No manual initTree needed - this was causing double-initialization bugs
        });
        document.body.addEventListener('htmx:historyRestore', function(event) {
            updateActiveNavbarTab();
            // Alpine's MutationObserver handles re-initialization automatically
        });
        window.addEventListener('popstate', updateActiveNavbarTab);
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
